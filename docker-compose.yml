services:
  openclaw-init:
    image: localhost:5000/openclaw-discord:latest
    volumes:
      - openclaw-data:/home/node/.openclaw
    environment:
      - AGENTS_DEFAULTS_MODEL_PROVIDERS__ZAI__API_KEY=${API_KEY}
    command: >
      sh -c '
      mkdir -p /home/node/.openclaw/agents/main/agent &&
      if [ ! -f /home/node/.openclaw/agents/main/agent/auth-profiles.json ] && [ -n "$$AGENTS_DEFAULTS_MODEL_PROVIDERS__ZAI__API_KEY" ]; then
        cat > /home/node/.openclaw/agents/main/agent/auth-profiles.json << "EOF"
      {
        "version": 1,
        "profiles": {
          "zai:default": {
            "type": "api_key",
            "provider": "zai",
            "key": "$$AGENTS_DEFAULTS_MODEL_PROVIDERS__ZAI__API_KEY"
          }
        },
        "lastGood": {
          "zai": "zai:default"
        },
        "usageStats": {
          "zai:default": {
            "lastUsed": 0,
            "errorCount": 0,
            "lastFailureAt": 0
          }
        }
      }
      EOF
      fi &&
      if [ ! -f /home/node/.openclaw/openclaw.json ]; then
        cat > /home/node/.openclaw/openclaw.json << "EOF"
      {
        "messages": {
          "ackReactionScope": "group-mentions"
        },
        "agents": {
          "defaults": {
            "maxConcurrent": 4,
            "subagents": {
              "maxConcurrent": 8
            },
            "compaction": {
              "mode": "safeguard"
            },
            "workspace": "/home/node/.openclaw/workspace",
            "models": {
              "zai/glm-4.7": {
                "alias": "GLM"
              }
            },
            "model": {
              "primary": "zai/glm-4.7"
            }
          }
        },
        "plugins": {
          "entries": {
            "discord": {
              "enabled": true
            }
          }
        },
        "meta": {
          "lastTouchedVersion": "2026.2.2-3"
        }
      }
      EOF
      fi
      '

  openclaw-gateway:
    image: localhost:5000/openclaw-discord:latest
    restart: unless-stopped
    depends_on:
      openclaw-init:
        condition: service_completed_successfully

    environment:
      # Core settings
      - NODE_ENV=production
      - HOME=/home/node
      - INSTANCE_NAME=${INSTANCE_NAME:-proofofclaw-coder}

      # Gateway configuration
      - OPENCLAW_GATEWAY_BIND=lan
      - OPENCLAW_GATEWAY_PORT=18789
      - OPENCLAW_GATEWAY_TOKEN=${GATEWAY_TOKEN}

      # Discord configuration
      - DISCORD_BOT_TOKEN=${DISCORD_BOT_TOKEN}
      - CHANNELS_DISCORD_TOKEN=${DISCORD_BOT_TOKEN}
      - CHANNELS_DISCORD_ENABLED=true
      - CHANNELS_DISCORD_GROUPPOLICY=allowlist
      - CHANNELS_DISCORD_GUILDS=${DISCORD_GUILDS}

      # Model configuration
      - AGENTS_DEFAULTS_MODEL_PRIMARY=${MODEL:-zai/glm-4.7}
      - AGENTS_DEFAULTS_MODEL_PROVIDERS__ZAI__API_KEY=${API_KEY}
      - AGENTS_DEFAULTS_WORKSPACE=/home/node/.openclaw/workspace
      - XDG_CONFIG_HOME=/home/node/.openclaw

    volumes:
      - openclaw-data:/home/node/.openclaw

    labels:
      - com.openclaw.instance=${INSTANCE_NAME:-proofofclaw-coder}

    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:18789/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    command: ["openclaw", "gateway", "--bind", "lan", "--port", "18789", "--allow-unconfigured"]

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

volumes:
  openclaw-data:
