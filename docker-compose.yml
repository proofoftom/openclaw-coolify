services:
  openclaw-init:
    image: localhost:5000/openclaw-discord:latest
    restart: "no"
    volumes:
      - openclaw-data:/home/node/.openclaw
    environment:
      - AGENTS_DEFAULTS_MODEL_PROVIDERS__ZAI__API_KEY=${API_KEY}
      - OPENCLAW_FORCE_UPDATE=${OPENCLAW_FORCE_UPDATE:-false}
    command:
      - sh
      - -c
      - |
        mkdir -p /home/node/.openclaw/agents/main/agent

        # Create auth-profiles.json if it doesn't exist
        if [ ! -f /home/node/.openclaw/agents/main/agent/auth-profiles.json ] && [ -n "$$AGENTS_DEFAULTS_MODEL_PROVIDERS__ZAI__API_KEY" ]; then
          cat > /home/node/.openclaw/agents/main/agent/auth-profiles.json << EOF
        {
          "version": 1,
          "profiles": {
            "zai:default": {
              "type": "api_key",
              "provider": "zai",
              "key": "$$AGENTS_DEFAULTS_MODEL_PROVIDERS__ZAI__API_KEY"
            }
          },
          "lastGood": {
            "zai": "zai:default"
          },
          "usageStats": {
            "zai:default": {
              "lastUsed": 0,
              "errorCount": 0,
              "lastFailureAt": 0
            }
          }
        }
        EOF
        fi

        # Create template for openclaw.json
        cat > /tmp/openclaw-template.json << EOF
        {
          "messages": {
            "ackReactionScope": "group-mentions"
          },
          "agents": {
            "defaults": {
              "maxConcurrent": 4,
              "subagents": {
                "maxConcurrent": 8
              },
              "compaction": {
                "mode": "safeguard"
              },
              "workspace": "/home/node/.openclaw/workspace",
              "models": {
                "zai/glm-4.7": {
                  "alias": "GLM"
                }
              },
              "model": {
                "primary": "zai/glm-4.7"
              }
            }
          },
          "channels": {
            "discord": {
              "groupPolicy": "open",
              "allowBots": true
            }
          },
          "plugins": {
            "entries": {
              "discord": {
                "enabled": true
              }
            }
          },
          "meta": {
            "lastTouchedVersion": "2026.2.2-3"
          }
        }
        EOF

        # Handle openclaw.json creation/update
        if [ ! -f /home/node/.openclaw/openclaw.json ]; then
          # Fresh deployment - use template as-is
          cp /tmp/openclaw-template.json /home/node/.openclaw/openclaw.json
        elif [ "$$OPENCLAW_FORCE_UPDATE" = "true" ]; then
          # Force update mode - replace entire config (destructive!)
          cp /tmp/openclaw-template.json /home/node/.openclaw/openclaw.json
          echo "⚠️  OPENCLAW_FORCE_UPDATE=true - replaced entire config, user customizations lost"
        else
          # Smart merge mode - preserve user customizations, add new template keys
          # User values win on conflicts (right side of merge takes precedence)
          if command -v jq >/dev/null 2>&1; then
            jq -s '.[0] * .[1]' /tmp/openclaw-template.json /home/node/.openclaw/openclaw.json > /tmp/openclaw-merged.json && \
              mv /tmp/openclaw-merged.json /home/node/.openclaw/openclaw.json
            echo "✓ Merged template into existing config (user customizations preserved)"
          else
            echo "⚠️  jq not available - skipping smart merge, keeping existing config"
          fi
        fi

  openclaw-gateway:
    image: localhost:5000/openclaw-discord:latest
    restart: unless-stopped
    depends_on:
      openclaw-init:
        condition: service_completed_successfully

    environment:
      # Core settings
      - NODE_ENV=production
      - HOME=/home/node
      - INSTANCE_NAME=${INSTANCE_NAME:-proofofclaw-default}

      # Gateway configuration
      - OPENCLAW_GATEWAY_BIND=lan
      - OPENCLAW_GATEWAY_PORT=18789
      - OPENCLAW_GATEWAY_TOKEN=${GATEWAY_TOKEN}

      # Discord configuration
      - DISCORD_BOT_TOKEN=${DISCORD_BOT_TOKEN}
      - CHANNELS_DISCORD_TOKEN=${DISCORD_BOT_TOKEN}
      - CHANNELS_DISCORD_ENABLED=true
      - CHANNELS_DISCORD_GUILDS=${DISCORD_GUILDS}

      # Model configuration
      - AGENTS_DEFAULTS_MODEL_PRIMARY=${MODEL:-zai/glm-4.7}
      - AGENTS_DEFAULTS_MODEL_PROVIDERS__ZAI__API_KEY=${API_KEY}
      - AGENTS_DEFAULTS_WORKSPACE=/home/node/.openclaw/workspace
      - XDG_CONFIG_HOME=/home/node/.openclaw

      # A2A configuration
      - OPENCLAW_A2A_ENABLED=true
      - OPENCLAW_A2A_NETWORK=openclaw-net
      - OPENCLAW_A2A_DISCOVERY_PORT=8765

    volumes:
      - openclaw-data:/home/node/.openclaw

    labels:
      - com.openclaw.instance=${INSTANCE_NAME:-proofofclaw-default}

    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:18789/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    command: ["openclaw", "gateway", "--bind", "lan", "--port", "18789", "--allow-unconfigured"]

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  openclaw-a2a-discovery:
    image: localhost:5000/openclaw-discord:latest
    restart: unless-stopped
    depends_on:
      openclaw-init:
        condition: service_completed_successfully

    environment:
      - NODE_ENV=production
      - HOME=/home/node
      - INSTANCE_NAME=${INSTANCE_NAME:-proofofclaw-default}

    volumes:
      - openclaw-data:/home/node/.openclaw

    labels:
      - com.openclaw.instance=${INSTANCE_NAME:-proofofclaw-default}-a2a

    # Expose A2A discovery port on openclaw-net
    expose:
      - "8765"

    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8765/agent-card.json"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    # Run the A2A discovery server from the workspace
    command: ["python3", "/home/node/.openclaw/workspace/skills/a2a-bridge/server.py"]

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

volumes:
  openclaw-data:

networks:
  default:
    name: openclaw-net
    external: true
